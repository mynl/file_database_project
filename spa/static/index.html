<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="static/favicon.ico" rel="icon">
  <title>File Finder (v 2.0)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 1rem 1.25rem; }
    .row { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
    input[type=text], select { padding: 0.4rem 0.6rem; min-width: 28rem; }
    button { padding: 0.45rem 0.8rem; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; table-layout: fixed; }
    th, td { border: 1px solid #ddd; padding: 0.4rem 0.5rem; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    th { background: #f3f3f3; position: sticky; top: 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .muted { color: #666; }

    /* Column widths + alignment */
    #results th.col-name,   #results td.col-name   { width: 50%; }
    #results th.col-subdir, #results td.col-subdir { width: 10%; }
    #results th.col-ext,    #results td.col-ext    { width: 6%;  }
    #results th.col-size,   #results td.col-size   { width: 10%; text-align: right; }
    #results th.col-mod,    #results td.col-mod    { width: 18%; }
    #results th.col-open,   #results td.col-open   { width: 6%;  }
  </style>
</head>
<body>
  <h2>File Finder</h2>

  <div class="row" style="margin-bottom:0.5rem;">
    <label for="project"><strong>Pick File Database Project:</strong></label>
    <select id="project"></select>
    <button id="loadBtn">Load</button>
    <span id="status" class="muted"></span>
  </div>

  <div class="row" style="margin-bottom:0.5rem; align-items:flex-start;">
    <div>
      <label for="query"><strong>Search as [term] [@ [d-n] [m-n] [y-n]]:</strong></label><br>
      <input id="query" type="text" placeholder="Search @ time…" />
    </div>
<!--     <div>
      <label for="timebox"><strong>Time:</strong></label><br>
      <input id="timebox" type="text" placeholder="today | today-3 | week | week-3 | month | month-3 | year | year-2" />
    </div> -->
  </div>

  <table id="results">
    <thead>
      <tr>
        <th class="col-name">Name</th>
        <th class="col-subdir">Subdir</th>
        <th class="col-ext">Ext</th>
        <th class="col-size">Size (bytes)</th>
        <th class="col-mod">Modified (UTC)</th>
        <th class="col-open">Open</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // Debounce utility
    function debounce(fn, delay) {
      let t = null;
      return function (...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), delay);
      }
    }

    const project = document.getElementById('project');
    const loadBtn = document.getElementById('loadBtn');
    const query = document.getElementById('query');
    // const timebox = document.getElementById('timebox');
    const status = document.getElementById('status');
    const tbody = document.querySelector('#results tbody');

    async function getJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    }
    async function postJSON(url, body) {
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    }
    function setStatus(msg) { status.textContent = msg || ''; }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    function renderRows(rows) {
      const frag = document.createDocumentFragment();
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono col-name" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</td>
          <td class="mono col-subdir" title="${escapeHtml(r.parent)}">${escapeHtml(r.parent)}</td>
          <td class="col-ext">${escapeHtml(r.ext || '')}</td>
          <td class="mono col-size"  style="text-align: right;">${r.size_bytes}</td>
          <td class="mono col-mod">${escapeHtml(r.modified_iso)}</td>
          <td class="col-open"><a href="#" data-path="${encodeURIComponent(r.path)}" class="open">Open</a></td>
        `;
        frag.appendChild(tr);
      }
      tbody.replaceChildren(frag);
    }

    async function loadProjects() {
      try {
        const data = await getJSON('/api/projects');
        project.replaceChildren();
        for (const item of (data.projects || [])) {
          const opt = document.createElement('option');
          opt.value = item.path;
          opt.textContent = item.title;
          project.appendChild(opt);
        }
        setStatus(`Found ${data.projects?.length || 0} projects.`);
      } catch (e) { setStatus(String(e)); }
    }

    async function loadProject() {
      const cfg = project.value;
      if (!cfg) { setStatus('Select a project.'); return; }
      setStatus('Loading project…');
      try {
        const resp = await postJSON('/api/load', { config: cfg });
        setStatus(`Loaded ${resp.rows} rows from ${resp.config}.`);
        await searchNow();
      } catch (e) { setStatus(String(e)); }
    }

    async function searchNow() {
      const q = encodeURIComponent(query.value.trim());
      // const t = encodeURIComponent(timebox.value.trim());
      try {
        const data = await getJSON(`/api/search?q=${q}&n=50`);
        renderRows(data.rows || []);
      } catch (e) { setStatus(String(e)); }
    }

    async function openPath(encodedPath) {
      try {
        await getJSON(`/api/open?path=${encodedPath}`);
      } catch (e) { setStatus(String(e)); }
    }

    tbody.addEventListener('click', (ev) => {
      const a = ev.target.closest('a.open');
      if (a) {
        ev.preventDefault();
        openPath(a.getAttribute('data-path'));
      }
    });

    loadBtn.addEventListener('click', loadProject);
    query.addEventListener('input', debounce(searchNow, 120));
    // timebox.addEventListener('input', debounce(searchNow, 120));

    // init
    loadProjects();
  </script>
</body>
</html>
